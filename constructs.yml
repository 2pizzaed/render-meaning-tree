# ================================
# Универсальные управляющие структуры
# ================================

# kind: compound, inline, any

# --------------------------------
# Глобальные операторы -- разновидность блока { ... }
# --------------------------------
global_statements_structure:
  kind: compound.sequence
  ast_node: program_entry_point
  actions:
    - role: first
      kind: any
      identification:
        origin: parent
        property_path: 'body / [0]'  # statements -> body
      generalization: item
    - role: next
      kind: any
      identification:
        origin: previous
        property_path: '[next]'
      generalization: item
  transitions:
    - from_: BEGIN
      to: first
    - from_: item
      to: next       # переход к следующему элементу
      to_when_absent: END

# --------------------------------
# Условный оператор (if / else-if / else)
# --------------------------------
simple_ifelse_structure:
  kind: compound.alternative_0              # тип действия (ветвление)
  actions:
    - role: cond             # условие ветвления
      kind: inline.condition        # true / false
    - role: if_branch           # ветка при true
      kind: compound
      generalization: branch
    - role: else_branch           # ветка при false
      kind: compound
      generalization: branch
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: if_branch
      constraints:
        condition_value: true        # если условие истинно → переход в "true"-ветку
    - from_: cond
      to: else_branch
      constraints:
        condition_value: false       # если ложно → в "false"-ветку
    - from_: branch
      to: END

# --------------------------------
# Условный оператор (if / else-if / else)
# --------------------------------
if_structure:
  kind: compound.alternative              # тип действия (ветвление)
  ast_node: if_statement
  actions:
    - role: first_cond             # первое условие ветвления
      kind: inline.condition        # true / false
      identification:
        # origin: parent
        # property: condition
        property_path: 'branches / [0] / condition'
        role_in_list: first_in_list
      generalization: cond
      # metadata:
      #   assumed_value: true
    - role: next_cond             # следующее условие ветвления
      kind: inline.condition
      identification:
        origin: previous
        # property: condition
        property_path: '^ / [next] / condition'
        role_in_list: next_in_list
      generalization: cond
    - role: if_branch           # ветка при true
      kind: compound
      identification:
        origin: previous
        # property: body
        property_path: '^ / body'
      generalization: branch
    - role: else_branch           # ветка при false
      kind: compound
      identification:
        # origin: parent
        property: elseBranch
      generalization: branch
  transitions:
    - from_: BEGIN
      to: first_cond
    - from_: cond
      to: if_branch                # → переход в "true"-ветку
      constraints:
        condition_value: true        # если условие истинно
    - from_: cond
      to: next_cond
      to_when_absent: ['else_branch', 'END']   # → в "false"-ветку
      constraints:
        condition_value: false       # если ложно
    - from_: branch
      to: END   # если ветка отсутствует, сразу окончание

# --------------------------------
# Цикл while
# --------------------------------
while_structure:
  kind: compound.loop
  ast_node: while_loop
  effects:
    - interruption_stop: break
  actions:
    - role: cond
      kind: inline.condition
      identification:
        property: condition
    - role: body
      kind: compound
      identification:
        property: body
      effects:
        - interruption_stop: continue
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true        # если условие истинно → выполняем тело
    - from_: cond
      to: END
      constraints:
        condition_value: false       # если ложно → выходим из цикла
    - from_: body
      to: cond                   # после тела возвращаемся к условию

# --------------------------------
# Цикл while+else (Python only)
# --------------------------------
while_else_structure:
  kind: compound.loop
  ast_node: while_else_loop
  effects:
    - interruption_stop: break
  actions:
    - role: cond
      kind: inline.condition
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: else
      kind: compound
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true      # если условие истинно → выполняем тело
    - from_: body
      to: cond                   # после тела возвращаемся к условию
    - from_: cond
      to: else
      constraints:
        condition_value: false     # если ложно → выходим в else
    - from_: else
      to: END

# --------------------------------
# Цикл do-while
# --------------------------------
do_while_structure:
  kind: compound.loop
  ast_node: do_while_loop  # TODO !!??
  effects:
    - interruption_stop: break
  actions:
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: cond
      kind: inline.condition
  transitions:
    - from_: BEGIN
      to: body
    - from_: body
      to: cond              # сначала выполняем тело
    - from_: cond
      to: body
      constraints:
        condition_value: true        # если условие истинно → снова тело
    - from_: cond
      to: END
      constraints:
        condition_value: false       # иначе → выход

# --------------------------------
# Цикл for (универсальная форма)
# --------------------------------
for_structure:
  kind: compound.loop
  ast_node: general_for_loop
  effects:
    - interruption_stop: break
  actions:
    - role: init
      kind: inline
    - role: cond
      kind: inline.condition
      behaviour:
        assumed_value: true
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: update
      kind: inline
  transitions:
    - from_: BEGIN
      to: init
    - from_: init
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true
    - from_: cond
      to: END
      constraints:
        condition_value: false       # false → выход
    - from_: body
      to: update
    - from_: update
      to: cond

# --------------------------------
# Цикл for each (по контейнеру)
# --------------------------------
for_each_structure:
  kind: compound.loop
  ast_node: for_each_loop
  effects:
    - interruption_stop: break
  actions:
    - role: cond
      kind: inline.condition
      identification:
        property: container
    - role: body
      kind: compound
      identification:
        property: body
      effects:
        - interruption_stop: continue
    - role: update
      kind: inline
      identification:
        property: item
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: update
      constraints:
        condition_value: true
    - from_: cond
      to: END
      constraints:
        condition_value: false       # false → выход
    - from_: update
      to: body
    - from_: body
      to: cond

# --------------------------------
# Блок операторов { ... }
# --------------------------------
block_structure:
  kind: compound.sequence
  ast_node: compound_statement
  actions:
    - role: first
      kind: any
      identification:
        origin: parent
        property_path: 'statements / [0]'
      generalization: item
    - role: next
      kind: any
      identification:
        origin: previous
        property_path: '[next]'
      generalization: item
  transitions:
    - from_: BEGIN
      to: first
    - from_: item
      to: next       # переход к следующему элементу
      to_when_absent: END

# --------------------------------
# Определение функции
# --------------------------------
func_def_structure:
  kind: compound.noop
  ast_node: function_definition
  actions:
    - role: name
      kind: identifier
      identification:
        property_path: 'declaration / name / name'
    - role: func_body
      kind: compound
      identification:
        property: 'body'
      effects:
        - interruption_stop: return
  transitions:
    - from_: BEGIN
      to: func_body
    - from_: func_body
      to: END

# --------------------------------
# Вызов функции
# --------------------------------
func_call_structure:
  kind: call
  ast_node: function_call
  actions:
    - role: name
      kind: identifier
      identification:
        property_path: 'function / name'
    - role: func
      kind: compound
      # identification: func def lookup (see Python code)
  transitions:
    - from_: BEGIN
      to: func
      effects:
        - call_stack: add_frame        # при входе в функцию создаём стековый фрейм
    - from_: func
      to: END
      effects:
        - call_stack: drop_frame       # при выходе убираем фрейм

# --------------------------------
# return
# --------------------------------
return_action:
  kind: inline  # this kind matters
  ast_node: return_statement
  effects:
    - interruption_start: return

# --------------------------------
# break
# --------------------------------
break_action:
  kind: inline
  ast_node: break  # TODO !!??
  effects:
    - interruption_start: break

# --------------------------------
# continue
# --------------------------------
continue_action:
  kind: inline
  ast_node: continue  # TODO !!??
  effects:
    - interruption_start: continue

# --------------------------------
# throw / raise
# --------------------------------
throw_action:
  kind: inline
  ast_node: throw_action  # TODO !!??
  effects:
    - interruption_start: exception
  # params:
  #   - exception_type  # TODO !!??


# --------------------------------
# labeled break
# --------------------------------
labeled_break_action:
  kind: inline
  ast_node: labeled_break  # TODO !!??
  effects:
    - interruption_start: break
  # params:
  #   - label_name  # TODO !!??


# --------------------------------
# Блок try-except c нетипизированной (неизбирательной) ловлей исключений
# --------------------------------
try_except_structure:
  kind: compound.try
  ast_node: try_except_statement  # TODO !!??
  effects:
    - interruption_stop: exception
  actions:
    - role: try
      kind: compound
      effects:
        - interruption_stop: exception
    - role: catch
      kind: compound
    - role: else     # entered if no exception was raised. Python only.
      kind: compound
    - role: finally
      kind: compound
  transitions:
    - from_: BEGIN
      to: try
    - from_: try
      to: catch                     # в блок catch, если
      constraints:
        interruption_mode: exception  # были исключения
      effects:
        - interruption_stop: exception
    - from_: try
      to: else                 # в блок else, если
    - from_: catch
      to: finally
      constraints:
        interruption_mode: any  # В любом случае
    - from_: else
      to: finally
      constraints:
        interruption_mode: any  # В любом случае
    - from_: finally
      to: END
