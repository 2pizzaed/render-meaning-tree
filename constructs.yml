# ================================
# Универсальные контрольные структуры
# ================================
# --------------------------------
# Условный оператор (if / else-if / else)
# --------------------------------
simple_ifelse_structure:
  kind: alternative_0              # тип действия (ветвление)
  actions:
    - role: cond             # условие ветвления
      kind: condition        # true / false
    - role: if_branch           # ветка при true
      kind: compound
      generalization: branch
    - role: else_branch           # ветка при false
      kind: compound
      generalization: branch
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: if_branch
      constraints:
        condition_value: true        # если условие истинно → переход в "true"-ветку
    - from_: cond
      to: else_branch
      constraints:
        condition_value: false       # если ложно → в "false"-ветку
    - from_: branch
      to: END

# --------------------------------
# Условный оператор (if / else-if / else)
# --------------------------------
if_structure:
  kind: alternative              # тип действия (ветвление)
  ast_node: if_statement
  actions:
    - role: first_cond             # первое условие ветвления
      kind: condition        # true / false
      identification:
        origin: parent
        # property: condition
        property_path: 'branches / [0] / condition'
        role_in_list: first_in_list
      generalization: cond
      # metadata:
      #   assumed_value: true
    - role: next_cond             # следующее условие ветвления
      kind: condition
      identification:
        origin: previous
        # property: condition
        property_path: '^ / [next] / condition'
        role_in_list: next_in_list
      generalization: cond
    - role: if_branch           # ветка при true
      kind: compound
      identification:
        origin: previous
        property: body
        property_path: '^ / body'
      generalization: branch
    - role: else_branch           # ветка при false
      kind: compound
      identification:
        origin: parent
        property: elseBranch
      generalization: branch
  transitions:
    - from_: BEGIN
      to: first_cond
    - from_: cond
      to: if_branch                # → переход в "true"-ветку
      constraints:
        condition_value: true        # если условие истинно
    - from_: cond
      to: next_cond
      to_when_absent: else_branch   # → в "false"-ветку
      constraints:
        condition_value: false       # если ложно
    - from_: branch
      to: END   # если ветка отсутствует, сразу окончание

# --------------------------------
# Цикл while
# --------------------------------
while_structure:
  kind: loop
  ast_node: while_loop
  effects:
    - interruption_stop: break
  actions:
    - role: cond
      kind: condition
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true        # если условие истинно → выполняем тело
    - from_: cond
      to: END
      constraints:
        condition_value: false       # если ложно → выходим из цикла
    - from_: body
      to: cond                   # после тела возвращаемся к условию

# --------------------------------
# Цикл while+else (Python only)
# --------------------------------
while_else_structure:
  kind: loop
  ast_node: while_else_loop
  effects:
    - interruption_stop: break
  actions:
    - role: cond
      kind: condition
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: else
      kind: compound
  transitions:
    - from_: BEGIN
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true      # если условие истинно → выполняем тело
    - from_: body
      to: cond                   # после тела возвращаемся к условию
    - from_: cond
      to: else
      constraints:
        condition_value: false     # если ложно → выходим в else
    - from_: else
      to: END

# --------------------------------
# Цикл do-while
# --------------------------------
do_while_structure:
  kind: loop
  ast_node: do_while_loop  # TODO !!??
  effects:
    - interruption_stop: break
  actions:
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: cond
      kind: condition
  transitions:
    - from_: BEGIN
      to: body
    - from_: body
      to: cond              # сначала выполняем тело
    - from_: cond
      to: body
      constraints:
        condition_value: true        # если условие истинно → снова тело
    - from_: cond
      to: END
      constraints:
        condition_value: false       # иначе → выход

# --------------------------------
# Цикл for (универсальная форма)
# --------------------------------
for_structure:
  kind: loop
  ast_node: general_for_loop
  effects:
    - interruption_stop: break
  actions:
    - role: init
      kind: atom
    - role: cond
      kind: condition
      behaviour:
        assumed_value: true
    - role: body
      kind: compound
      effects:
        - interruption_stop: continue
    - role: update
      kind: atom
  transitions:
    - from_: BEGIN
      to: init
    - from_: init
      to: cond
    - from_: cond
      to: body
      constraints:
        condition_value: true
    - from_: cond
      to: END
      constraints:
        condition_value: false       # false → выход
    - from_: body
      to: update
    - from_: update
      to: cond

# --------------------------------
# Блок операторов { ... }
# --------------------------------
block_structure:
  kind: sequence
  ast_node: compound_statement
  actions:
    - role: first
      kind: action
      identification:
        origin: parent
        property_path: 'statements / [0]'
        role_in_list: first_in_list
      generalization: item
    - role: next
      kind: action
      identification:
        origin: previous
        property_path: '^ / [next]'
        role_in_list: next_in_list
      generalization: item
  transitions:
    - from_: BEGIN
      to: first
    - from_: item
      to: next       # переход к следующему элементу
      to_when_absent: END

# --------------------------------
# Вызов функции
# --------------------------------
call_structure:
  kind: call
  ast_node: call  # TODO !!??
  actions:
#    - role: func_call
#      kind: expression
    - role: func_body
      kind: compound
      effects:
        - interruption_stop: return
  transitions:
    - from_: BEGIN
      to: func_body
      effects:
        - call_stack: add_frame        # при входе в функцию создаём стековый фрейм
    - from_: func_body
      to: END
      effects:
        - call_stack: drop_frame       # при выходе убираем фрейм

# --------------------------------
# return
# --------------------------------
return_action:
  kind: atom
  ast_node: return  # TODO !!??
  effects:
    - interruption_start: return

# --------------------------------
# break
# --------------------------------
break_action:
  kind: atom
  ast_node: break  # TODO !!??
  effects:
    - interruption_start: break

# --------------------------------
# continue
# --------------------------------
continue_action:
  kind: atom
  ast_node: continue  # TODO !!??
  effects:
    - interruption_start: continue

# --------------------------------
# throw / raise
# --------------------------------
throw_action:
  kind: atom
  ast_node: throw_action  # TODO !!??
  effects:
    - interruption_start: exception
  # params:
  #   - exception_type  # TODO !!??


# --------------------------------
# labeled break
# --------------------------------
labeled_break_action:
  kind: atom
  ast_node: labeled_break  # TODO !!??
  effects:
    - interruption_start: break
  # params:
  #   - label_name  # TODO !!??


# --------------------------------
# Блок try-except c нетипизированной (неизбирательной) ловлей исключений
# --------------------------------
try_except_structure:
  kind: try
  ast_node: try_except_statement  # TODO !!??
  effects:
    - interruption_stop: break
  actions:
    - role: try
      kind: compound
      effects:
        - interruption_stop: continue
    - role: catch
      kind: compound
    - role: else     # entered if no exception was raised. Python only.
      kind: compound
    - role: finally
      kind: compound
  transitions:
    - from_: BEGIN
      to: try
    - from_: try
      to: catch                     # в блок catch, если
      constraints:
        interruption_mode: exception  # были исключения
      effects:
        - interruption_stop: exception
    - from_: try
      to: else                 # в блок else, если
    - from_: catch
      to: finally
      constraints:
        interruption_mode: any  # В любом случае
    - from_: else
      to: finally
      constraints:
        interruption_mode: any  # В любом случае
    - from_: finally
      to: END
